Course Management Application (detailed, implementation-ready)

Goal
Design and implement a full-stack course management application that supports four user roles (Administrator, Moderator, Instructor, Student) and covers scheduling, classroom allocation, assignment management, and file uploads. The system must be production-ready, secure, and deployable to Vercel with course assets stored in Cloudflare R2 and persistent data in PostgreSQL.

Target audience / stakeholders

Administrators: full system control — manage users, roles, rooms, global settings, reporting, and audits.

Moderators: help manage community content and course enrollment requests; limited system settings.

Instructors: create and manage courses, lessons, schedules, assignments, grade submissions, and communicate with students.

Students: view personal timetable, join courses, access lesson materials, submit homework, and view grades/feedback.

Tech stack (explicit)

Frontend & backend: Next.js (fullstack; App Router or Pages Router acceptable)

Database: PostgreSQL (hosted) — use an ORM such as Prisma or equivalent for schema + migrations

Object storage: Cloudflare R2 (S3-compatible) — server-side uploads and signed URLs for client uploads/downloads

Hosting: Vercel for Next.js deployment (serverless functions / edge functions as appropriate)

Authentication / Authorization: NextAuth.js, or JWT-based system with RBAC; session cookies with secure flags

API design: tRPC or REST API routes inside Next.js; GraphQL optional for a more flexible client

File handling: server-side streaming uploads to R2 or direct browser → signed upload to R2 (recommended)

Optional: WebSocket or server-sent events for realtime notifications (e.g., class cancellation)

Core functional requirements (MVP)

User management & roles

Registration and profile management.

Role assignment: Administrator, Moderator, Instructor, Student.

Role-based access control checks on every protected API endpoint.

Course, lesson, and timetable management

Create courses and course sections (term/semester).

Lessons: title, description, duration, materials (links/files), instructor.

Timetable/schedule model: which lesson, which day, start/end time, assigned room.

Rooms: id, name, capacity, resources (projector, lab).

Student view: daily/weekly timetable showing lessons and rooms.

Enrollment and permissions

Students can enroll in courses (manual approval optional).

Instructors can manage enrollments for their courses.

Moderators can accept/reject enrollment requests if configured.

Assignment/homework flow

Instructor creates assignments with due date, allowed file types, max size.

Students submit homework (files + optional text).

Submission status/history, timestamping, and versioning.

Instructor can grade and leave feedback; grade history visible to student.

File storage & retrieval

Store uploaded homework and course materials in Cloudflare R2.

Provide secure, time-limited URLs for downloads.

Virus/malware scanning integration point (optional webhook).

Notifications & reminders

Email or in-app notifications for upcoming lessons, new assignments, grading, room changes.

Configurable notification preferences.

Audit & logging

Record critical actions (user role changes, assignment grading, enrollment changes).

Admin reporting dashboard for usage metrics.

Data model (recommended tables & key fields)

users: id (uuid), email, hashed_password, name, role_id, profile_avatar_url, created_at, last_login

roles: id, name (admin, moderator, instructor, student), permissions (JSON or normalized roles table)

courses: id, code, title, description, term, visibility, created_by (instructor id), created_at

sections: id, course_id, instructor_id, capacity, term

rooms: id, name, location, capacity, resources (JSON)

lessons: id, section_id, title, description, date (nullable for recurring), day_of_week (nullable), start_time, end_time, room_id, material_ids (array)

schedules (if separate): id, lesson_id, date, room_id, is_cancelled, notes

enrollments: id, user_id, section_id, status (enrolled/pending/withdrawn), enrolled_at

assignments: id, section_id, title, description, due_date, allowed_file_types, max_size_bytes, created_by

submissions: id, assignment_id, student_id, file_key (R2), text, submitted_at, grade, feedback, graded_at

files: id, owner_id, key (R2), filename, mime_type, size_bytes, uploaded_at

notifications: id, user_id, type, payload (JSON), read_at, created_at

audit_logs: id, user_id, action, target_type, target_id, details (JSON), created_at

API endpoints (examples)

Use REST or tRPC. Example REST routes:

POST /api/auth/login, POST /api/auth/logout, GET /api/me

GET /api/courses, POST /api/courses, GET /api/courses/:id

POST /api/sections/:id/enroll (student), GET /api/sections/:id/enrollments (instructor)

GET /api/sections/:id/schedule, POST /api/lessons (instructors/admins)

POST /api/assignments, GET /api/assignments/:id, POST /api/assignments/:id/submissions

POST /api/files/sign-upload → returns signed URL for direct browser → R2 upload

GET /api/files/:id/signed-url → returns signed download URL

GET /api/admin/reports (admin only)

UI structure and pages (per role)

Global layout: authenticated header with role switch UI (admin tools visible only to admins)

Public: landing, login, register, docs/help

Student dashboard: enrolled courses, personal timetable (day/week), upcoming assignments, submissions, messages

Instructor dashboard: managed courses, class schedule, create lesson/assignment, submissions queue, grading interface

Moderator dashboard: enrollment requests, flagged content, role management tools (limited)

Admin dashboard: full user list, role management, room management, system settings, reports, audit logs

Specific UI details:

Timetable view: day columns and time rows; room shown per lesson; click a lesson to view details and materials.

Assignment submission flow: "Submit" button opens file picker, shows allowed file types and max size, shows upload progress.

Grading UI: list of submissions, quick grade inline, attach feedback file or comments, bulk-download option for submissions.

Security & compliance

Use HTTPS everywhere; secure cookies with SameSite/HttpOnly/secure flags.

Strong password policy and optional MFA.

RBAC middleware on serverless functions and API routes.

Validate/limit file types and sizes; scan uploaded files.

Rate limiting on public endpoints and auth endpoints.

GDPR considerations: data deletion API for users; data retention policies.

Secrets: store DB credentials, R2 keys, and third-party secrets as Vercel environment variables.

Cloudflare R2 integration notes (implementation hints)

Use signed upload URLs for direct client → R2 uploads to avoid passing binary through serverless functions.

Alternatively use server-side streaming for smaller scale.

R2 is S3-compatible; use AWS SDK S3 client configured with R2 account ID and endpoint.

Store files table records with the key used in R2 and keep metadata locally for fast queries.

Persistence, migrations, and ORM

Use Prisma (recommended) or TypeORM to manage schema and migrations.

Provide seed scripts to create sample admin, instructor, student accounts, sample course, schedule, assignments, and submissions.

Testing & quality

Unit tests for business logic (Jest).

Integration tests for API endpoints (Supertest or Playwright for end-to-end UI).

End-to-end scenarios: enroll → view timetable → submit assignment → grade.

Security scans and dependency checks in CI.

Deployment & CI/CD

Vercel for frontend + serverless API routes.

Database hosted separately (e.g., Neon, Supabase, or managed Postgres). Ensure network accessibility and connection pooling for serverless.

CI pipeline: run lint, typecheck, tests, build. On success, auto-deploy to Vercel.

Environment variables: DATABASE_URL, R2_ACCESS_KEY_ID, R2_SECRET_ACCESS_KEY, R2_BUCKET, NEXTAUTH_SECRET, SMTP_* for email.

Acceptance criteria / Definition of Done (MVP)

Authenticated roles with RBAC enforced.

Instructor can create course, lessons, and schedule lessons into rooms and times.

Students see a personal timetable mapping days → lessons → rooms.

Assignment creation and student submission flow are complete, with uploaded files in R2 and visible to instructor.

Basic notification for new assignment and grade.

Basic admin panel to manage users and rooms.

Automated tests (unit + integration) with >70% coverage for core flows.

Example seed data (concise)

Admin: admin@example.com

Instructor: alice.instructor@example.com

Student: bob.student@example.com

Rooms: Lecture Hall A, Lab 2

Course: "Intro to Web Development", Section A, instructor Alice

Lesson: Monday 09:00–11:00 in Lecture Hall A

Non-functional & stretch features

Calendar export (iCal) and Google Calendar integration.

Realtime presence and short notice classroom changes via WebSockets.

Bulk upload of materials for a course.

Analytics dashboard: course engagement, submission rates, late submissions.

Mobile-first responsive UI and PWA support for offline access to materials.

Deliverables to request from an engineer or AI

Database schema (Prisma schema + migrations)

Auth flows and RBAC middleware implementation

Next.js project scaffolding with example pages for each role

File upload service: signed URL generation and R2 storage integration

Assignment submission and grading APIs + UI

Seed script and integration tests

Deployment instructions and environment variables list